#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

GETTEXT_TARBALL=http://fb_wanted.s3.amazonaws.com/bp/gettext.tar.gz
TARGET_DIR=$HOME
BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

if [ -d $TARGET_DIR/gettext ]; then
	echo "$PWD/gettext already installed"
	exit 0
fi

echo "-----> Installing gettext..."
curl --silent --max-time 60 --location "$GETTEXT_TARBALL" | tar xz
echo "-----> done in $TARGET_DIR/gettext"


set -eo pipefail
# The post_compile hook is run by heroku-buildpack-python

indent() {
    RE="s/^/       /"
    [ $(uname) == "Darwin" ] && sed -l "$RE" || sed -u "$RE"
}

echo "-----> In post-compile hook"

if [ ! -d $TARGET_DIR/gettext ]; then
    echo "-----> Installing gettext msgfmt..."

    GETTEXT_CHECKSUM="ceZfT0KqGBZyr52s/9yULR3vsmXPS5HmUcs+dup/DXg="
    GETTEXT_TARBALL=https://s3-eu-west-1.amazonaws.com/midgard-heroku/gettext.tar.gz

    # tempdir="$( mktemp -t gettext_XXXX )"
    # rm -rf $tempdir
    # mkdir -p $tempdir
    pushd $BUILD_DIR >/dev/null
    rm -f tmp-gettext.tar.gz

    curl -s -L -o tmp-gettext.tar.gz "$GETTEXT_TARBALL"
    if [ "$GETTEXT_CHECKSUM" != "$(openssl sha -sha256 -binary tmp-gettext.tar.gz | openssl base64)" ]; then
        echo "Checksum DOES NOT match. Gettext will not be installed."
        exit 1
    fi
    tar -zxvf tmp-gettext.tar.gz > /dev/null
    rm tmp-gettext.tar.gz
    popd >/dev/null

    export PATH=$BUILD_DIR/gettext/bin:$PATH

    # ln -s -f ../../vendor/gettext/bin/msgfmt .heroku/python/bin/msgfmt

    echo "-----> done installing gettext msgfmt"
fi

echo "-----> Post-compile done"
