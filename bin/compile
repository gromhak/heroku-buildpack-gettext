#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

GETTEXT_TARBALL=http://fb_wanted.s3.amazonaws.com/bp/gettext.tar.gz
TARGET_DIR=$HOME
BUILD_DIR=$1
CACHE_DIR=$2

cd $BUILD_DIR

if [ -d $TARGET_DIR/gettext ]; then
	echo "$PWD/gettext already installed"
	exit 0
fi

echo "-----> Installing gettext..."
curl --silent --max-time 60 --location "$GETTEXT_TARBALL" | tar xz
echo "-----> done in $TARGET_DIR/gettext"


set -eo pipefail
# The post_compile hook is run by heroku-buildpack-python
indent() {
   RE="s/^/       /"
   [ $(uname) == "Darwin" ] && sed -l "$RE" || sed -u "$RE"
}
echo "-----> In post-compile hook"
export PATH=/app/gettext/bin:$PATH
MANAGE_FILE=$(find . -maxdepth 3 -type f -name 'manage.py' | head -1)
MANAGE_FILE=${MANAGE_FILE:2}
echo "-----> Compiling translation files"
python "$MANAGE_FILE" compilemessages 2>&1 | indent
echo "-----> Done post-compile hook"
echo ""
